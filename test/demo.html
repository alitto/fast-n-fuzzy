<html>

<head>
	<title>Fast n' Fuzzy Demo Page</title>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
	<script type="text/javascript" src="../dist/fast-n-fuzzy.min.js"></script>
	<script>

	$.ajax("countries.json", {
		type: "get",
		dataType: "json",
		success: function(countries){
			initIndex(countries);
		}
	});

	var searchIndex;
	function initIndex(words){

		searchIndex = new FastNFuzzy();

		// Populate index
		for(var i = 0; i < words.length; i++){
			var word = words[i];
			searchIndex.add(word, word);
		}

		// Bind search event
		$('#query').on('keyup', function(e){
			doSearch($(this).val(), 100, 10);
		});

		$('#query').focus();

		//runTest(words, 2);
	}

	function doSearch(query, maxDistance, maxResults){
		var results = searchIndex.search(query, maxDistance, maxResults);
		var result;

		var div = $('#results');
		div.html('');
		for(var i = 0; i < results.length; i++){
			if(i + 1 >= maxResults) break;
			result = results[i];
			div.append('<p>Result (' + (i + 1) + '): ' + result.distance + ' - ' + result.value + '</p>');
		}
		if(results.length == 0){
			div.html('No results');
		}
	}

	function runTest(countries, tolerance){
		var efficacySum = 0;
		for(var i = 0; i < countries.length; i++){
			efficacySum += testWord(countries[i], tolerance);
		}

		console.log("Avg. efficacy: ", efficacySum / countries.length);
	}

	function testWord(word, tolerance){
		
		var attempts = 0;
		var success = 0;

		// As it is
		success += assertEquals(word, word, tolerance);
		attempts++;

		// Test removing 1 letter
		for(var i = 0; i < word.length; i++){
			var parts = word.split("");
			var chr = word.substring(i, i+1);
			if(chr != ' '){
				parts.splice(i, 1);
				var mod = parts.join("");
				success += assertEquals(word, mod, tolerance);
				attempts++;
			}
		}

		// Test swapping 1 char
		for(var i = 0; i < word.length; i++){
			var chr = word.substring(i, i+1);
			if(chr != ' '){
				var rnd = swapChar(chr);
				var mod = word.substring(0, i) + rnd + word.substring(i + 1);
				success += assertEquals(word, mod, tolerance);
				attempts++;
			}
		}

		var efficacy = success / attempts;
		//console.log("Efficacy for " + word + ": " + efficacy);

		return efficacy;
	}

	function assertEquals(expected, word, tolerance){
		var results = searchIndex.search(word, 100, tolerance);
		if(results.length > 0){
			for(var i = 0; i < results.length; i++){
				if(results[i].value == expected){
					return 1;
				}
			}
			console.log("Failed", expected, word, results);
		}
		return 0;
	}

	var minChar = "a".charCodeAt(0);
	var maxChar = "z".charCodeAt(0);
	function swapChar(chr){
		var rnd;
		do{
			rnd = String.fromCharCode(Math.round(minChar + Math.random() * (maxChar - minChar)));
		}while(rnd == chr);
		return rnd;
	}

	</script>
</head>
<body>

<p>Search <input id="query" type="text" /></p>

<div id="results">

</div>


</body>
</html>